# 双摇杆遥控与级联控制方案

> **状态：** 已部分实现 (v2.0) | **更新日期：** 2026-02-15

本文档描述平衡车的控制架构设计和遥控方案。

---

## 当前实现状态

### ✅ 已实现
- **级联控制架构** (Velocity → Angle)
- **双摇杆遥控** (速度 + 转向)
- **HAL抽象层** (IMU、编码器接口)
- **Web界面调参**
- **参数持久化** (Flash存储)

### ⏳ 未来扩展
- **位置环** (Position → Velocity → Angle 3层级联)
- **偏航角控制** (当前为纯速率阻尼，可扩展为角度+速率双环)

---

## 级联控制架构

### 当前架构 (2层)

```
┌─────────────────────────────────────────────────────────────┐
│  Command Input                                              │
│  ├── target_velocity (m/s)    <- 左摇杆前后                │
│  └── target_yaw_rate (rad/s)  <- 右摇杆左右                │
└──────────────────────────┬──────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────┐
│  Velocity Loop (外环) - 50Hz                                 │
│  ├── 输入: velocity_error = target_vel - current_vel         │
│  ├── 输出: pitch_cmd (目标倾角)                              │
│  └── 限制: ±velocity_max_tilt                               │
└──────────────────────────┬──────────────────────────────────┘
                           │ pitch_cmd
┌──────────────────────────▼──────────────────────────────────┐
│  Angle Loop (内环) - 200Hz                                   │
│  ├── 输入: pitch_error = current_pitch - (pitch_cmd + offset)│
│  ├── PID: Kp*error + Ki*∫error                               │
│  ├── D项: gyro_kd * filtered_pitch_rate (手动实现)            │
│  └── 输出: motor_voltage                                     │
└──────────────────────────┬──────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────┐
│  Yaw Mixing                                                │
│  └── yaw_output = target_yaw_rate - yaw_kd * yaw_rate       │
└──────────────────────────┬──────────────────────────────────┘
                           │
┌──────────────────────────▼──────────────────────────────────┐
│  Motor Output                                               │
│  ├── left_motor  = -0.5 * (motor_output + yaw_output)       │
│  └── right_motor = -0.5 * (motor_output - yaw_output)       │
└─────────────────────────────────────────────────────────────┘
```

### 设计决策

**为什么选择2层而非3层？**

1. **简化调试** - 内环(angle)调好后，再调外环(velocity)
2. **遥控场景** - 位置环在遥控模式下意义不大（遥杆直接控制速度）
3. **资源限制** - ESP32-S3的200Hz控制频率足够2层，3层需谨慎

**位置环何时添加？**
- 需要"定点模式"时（机器人保持在固定位置）
- 自动导航/路径规划时

---

## 双摇杆映射

| 摇杆 | 方向 | 控制量 | 范围 | 物理单位 |
|------|------|--------|------|----------|
| 左摇杆 | 前后 | 目标线速度 | ±0.5 | m/s |
| 右摇杆 | 左右 | 目标偏航角速度 | ±3.0 | rad/s |

### 安全限制

```cpp
max_linear_velocity = 0.5 m/s      // 最大线速度
max_yaw_rate = 3.0 rad/s           // 最大偏航速度 (~172°/s)
linear_deadband = 0.05             // 线速度死区
yaw_deadband = 0.1                 // 偏航死区
```

---

## 模式切换逻辑

### 遥控模式 (remote_mode = true)
- 遥杆直接控制速度和转向
- 速度环跟踪遥杆输入
- 适用于手动驾驶

### 定点模式 (remote_mode = false)
- 目标速度 = 0
- 机器人尝试保持当前位置
- 适用于稳定站立、抗干扰

### 切换逻辑
- 进入 `/control` 页面 → 自动启用遥控模式
- 离开页面或点击停止 → 恢复定点模式
- 主页面显示当前模式状态

---

## 参数说明

### 速度环参数 (Velocity Loop)

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| velocity_kp | 0.15 | 0.0-0.5 | 速度跟踪增益 |
| velocity_ki | 0.02 | 0.0-0.1 | 积分消除稳态误差 |
| velocity_kd | 0.0 | 0.0-0.01 | 微分（通常禁用）|
| velocity_max_tilt | 0.14 | 0.05-0.3 | 最大倾斜命令 (~8°) |

### 角度环参数 (Angle Loop)

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| angle_kp | 1.5 | 0.5-5.0 | 角度恢复力 |
| angle_ki | 0.0 | 0.0-0.5 | 积分（通常禁用）|
| angle_gyro_kd | 0.6 | 0.1-3.0 | 角速度阻尼 |
| angle_d_alpha | 0.7 | 0.0-1.0 | D项滤波系数 |
| angle_max_out | 6.0 | 2.0-12.0 | 输出电压限幅 |

### 转向参数 (Yaw Control)

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| yaw_kd | 1.2 | 0.5-3.0 | 转向阻尼 |

**注意：** 当前为纯速率阻尼，如需heading hold需添加 `yaw_kp`

### 安全参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| max_tilt | 0.6 | 0.3-1.0 | 安全倾角限制 (~35°) |
| ramp_time | 0.5 | 0.1-2.0 | 启动斜坡时间 |
| pitch_offset | 0.0 | -0.1-0.1 | 静态零点偏置 (rad) |

---

## 调参建议

### 标准流程

1. **禁用速度环** (`velocity_kp = 0`)
2. **调整 angle_kp** - 让机器人能站起来
3. **调整 angle_gyro_kd** - 消除振荡
4. **启用速度环** (`velocity_kp = 0.15`)
5. **微调 velocity_ki** - 消除位置漂移

详见：`docs/PARAMETER_TUNING_GUIDE.md`

---

## 历史版本

### v1.0 (2026-02-12 提案)
- 3层控制：Position → Velocity → Angle
- 位置估计：编码器积分
- 偏航估计：陀螺仪积分

### v2.0 (2026-02-15 当前)
- 2层控制：Velocity → Angle
- 位置环推迟实现
- Yaw控制简化为纯速率阻尼

---

## 参考文档

- 参数调优指南：`docs/PARAMETER_TUNING_GUIDE.md`
- 架构决策：`docs/decisions/2026-02-12-cascade-control-separation.md`
- 代码：`src/control/balance_controller.h`
