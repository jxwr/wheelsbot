# å¹³è¡¡è½¦å‚æ•°è°ƒè¯•æŒ‡å—

æœ¬æ–‡æ¡£è®°å½•äº†ä¸¤è½®è‡ªå¹³è¡¡è½¦çš„å‚æ•°è°ƒè¯•æµç¨‹ï¼ŒåŸºäº**çº§è”æ§åˆ¶æ¶æ„**ï¼ˆé€Ÿåº¦ç¯â†’è§’åº¦ç¯ï¼‰ã€‚

> **ç‰ˆæœ¬ï¼š** v2.0 | **æ›´æ–°æ—¥æœŸï¼š** 2026-02-15
> **é€‚ç”¨ä»£ç ï¼š** `src/control/balance_controller.h` (Cascade Controller)

---

## ğŸ“š ç›®å½•

1. [æ§åˆ¶å™¨æ¶æ„](#æ§åˆ¶å™¨æ¶æ„)
2. [å‚æ•°è¯´æ˜](#å‚æ•°è¯´æ˜)
3. [è°ƒè¯•æµç¨‹](#è°ƒè¯•æµç¨‹)
4. [é—®é¢˜è¯Šæ–­](#é—®é¢˜è¯Šæ–­)
5. [å‚æ•°é€ŸæŸ¥è¡¨](#å‚æ•°é€ŸæŸ¥è¡¨)

---

## æ§åˆ¶å™¨æ¶æ„

### çº§è”æ§åˆ¶ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Velocity Loop (å¤–ç¯) - 50Hz                                 â”‚
â”‚  â”œâ”€â”€ è¾“å…¥: ç›®æ ‡é€Ÿåº¦ - å½“å‰é€Ÿåº¦                                â”‚
â”‚  â”œâ”€â”€ è¾“å‡º: ç›®æ ‡å€¾è§’ (pitch_cmd)                              â”‚
â”‚  â””â”€â”€ é™åˆ¶: Â±velocity_max_tilt (é»˜è®¤ Â±0.14 rad / Â±8Â°)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ pitch_cmd
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Angle Loop (å†…ç¯) - 200Hz                                   â”‚
â”‚  â”œâ”€â”€ è¾“å…¥: å½“å‰å€¾è§’ - (pitch_cmd + pitch_offset)             â”‚
â”‚  â”œâ”€â”€ Pé¡¹: angle_kp * pitch_error                             â”‚
â”‚  â”œâ”€â”€ Ié¡¹: angle_ki * âˆ«pitch_error (é€šå¸¸ç¦ç”¨)                  â”‚
â”‚  â”œâ”€â”€ Dé¡¹: angle_gyro_kd * filtered_pitch_rate (æ‰‹åŠ¨å®ç°)      â”‚
â”‚  â””â”€â”€ è¾“å‡º: ç”µæœºç”µå‹                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Yaw Control (å·®åˆ†è½¬å‘)                                      â”‚
â”‚  â””â”€â”€ yaw_output = target_yaw_rate - yaw_kd * yaw_rate        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®å‚æ•°è¯´æ˜

| å‚æ•° | ç‰©ç†æ„ä¹‰ | å…¸å‹å€¼ | å½±å“ |
|------|---------|--------|------|
| `velocity_kp` | é€Ÿåº¦è·Ÿè¸ªå¢ç›Š | 0.10-0.25 | å¤ªå°â†’æºœè½¦ï¼›å¤ªå¤§â†’æŒ¯è¡ |
| `velocity_ki` | é€Ÿåº¦ç§¯åˆ† | 0.0-0.05 | æ¶ˆé™¤ç¨³æ€è¯¯å·®ï¼Œè¿‡å¤§â†’ç§¯åˆ†é¥±å’Œ |
| `angle_kp` | è§’åº¦æ¢å¤åŠ› | 1.5-3.5 | å¤ªå°â†’æ— æ³•ç«™ç«‹ï¼›å¤ªå¤§â†’è¿‡å†²æŒ¯è¡ |
| `angle_gyro_kd` | è§’é€Ÿåº¦é˜»å°¼ | 0.4-1.2 | å¤ªå°â†’æŒ¯è¡ï¼›å¤ªå¤§â†’ååº”è¿Ÿé’ |
| `angle_ki` | è§’åº¦ç§¯åˆ† | 0.0 | é€šå¸¸ç¦ç”¨ï¼Œé˜²æ­¢æ¼‚ç§» |
| `yaw_kd` | è½¬å‘é˜»å°¼ | 1.0-2.0 | é«˜é‡å¿ƒéœ€è¦æ›´å¤§å€¼ |
| `pitch_offset` | ä¿¯ä»°é›¶ç‚¹åç½® | -0.05~0.05 rad | è¡¥å¿é‡å¿ƒåç§» |
| `angle_max_out` | è¾“å‡ºé™å¹… | 6.0-8.0 V | é˜²æ­¢ç”µæœºè¿‡é¥±å’Œ |

---

## è°ƒè¯•æµç¨‹

### é˜¶æ®µ1ï¼šåŸºç¡€ç«™ç«‹ï¼ˆangle_kp + angle_gyro_kdï¼‰

**ç›®æ ‡ï¼š** è®©æœºå™¨äººèƒ½ç«™ç«‹ä¸å€’

```cpp
// åˆå§‹ä¿å®ˆå‚æ•°
angle_kp = 1.5;
angle_gyro_kd = 0.6;
angle_ki = 0.0;           // ç¦ç”¨
velocity_kp = 0.0;        // å…ˆç¦ç”¨é€Ÿåº¦ç¯
velocity_ki = 0.0;
```

#### æ­¥éª¤1ï¼šè°ƒæ•´ angle_kp

- **æœºå™¨äººå€’ä¸‹** â†’ `angle_kp += 0.3`
- **èƒ½ç«™ç«‹ä½†æŒ¯è¡** â†’ è¿›å…¥æ­¥éª¤2
- **èƒ½ç«™ç«‹ä¸”ç¨³å®š** â†’ è¿›å…¥æ­¥éª¤2

**ç»éªŒå€¼ï¼š**
- 500gè½»é‡æœºå™¨äººï¼š`angle_kp = 1.5-2.0`
- 1kgä¸­ç­‰æœºå™¨äººï¼š`angle_kp = 2.0-3.0`
- é«˜é‡å¿ƒé…ç½®ï¼š`angle_kp += 0.5`

#### æ­¥éª¤2ï¼šè°ƒæ•´ angle_gyro_kd æŠ‘åˆ¶æŒ¯è¡

- **PitchæŒ¯å¹… > 2Â°** â†’ `angle_gyro_kd += 0.15`
- **PitchæŒ¯å¹… < 0.5Â°** â†’ `angle_gyro_kd -= 0.05`
- **ç›®æ ‡æŒ¯å¹…ï¼š** 0.5Â° - 1.5Â°

**æ³¨æ„ï¼š**
- `angle_gyro_kd` è¿‡å¤§ä¼šå¯¼è‡´ç³»ç»Ÿååº”è¿Ÿé’
- ç¡¬è´¨è½®èƒéœ€è¦æ›´å¤§çš„é˜»å°¼ï¼ˆ0.8-1.2ï¼‰

---

### é˜¶æ®µ2ï¼šé€Ÿåº¦æ§åˆ¶ï¼ˆvelocity_kp + velocity_kiï¼‰

**ç›®æ ‡ï¼š** é˜²æ­¢æºœè½¦ï¼Œä¿æŒç¨³å®šä½ç½®

```cpp
velocity_kp = 0.15;   // ä»ä¿å®ˆå€¼å¼€å§‹
velocity_ki = 0.02;   // å°ç§¯åˆ†æ¶ˆé™¤ç¨³æ€è¯¯å·®
```

#### æ­¥éª¤3ï¼šå¯ç”¨é€Ÿåº¦ç¯

- **æœºå™¨äººä»æºœè½¦** â†’ `velocity_kp += 0.05`
- **å¼•èµ·æŒ¯è¡** â†’ `velocity_kp -= 0.03`
- **ç›®æ ‡ï¼š** ä½ç½®åŸºæœ¬å›ºå®š

**æ³¨æ„ï¼š**
- é€Ÿåº¦ç¯è¿è¡Œé¢‘ç‡æ˜¯è§’åº¦ç¯çš„1/4ï¼ˆ50Hz vs 200Hzï¼‰
- `velocity_max_tilt` é™åˆ¶æœ€å¤§å€¾æ–œå‘½ä»¤ï¼ˆé»˜è®¤ 0.14 rad â‰ˆ 8Â°ï¼‰

---

### é˜¶æ®µ3ï¼šè½¬å‘æ§åˆ¶ï¼ˆyaw_kdï¼‰

**ç›®æ ‡ï¼š** ç¨³å®šè½¬å‘å“åº”

```cpp
yaw_kd = 1.2;   // é«˜é‡å¿ƒéœ€è¦æ›´å¤§é˜»å°¼
```

- **è½¬å‘è¿‡äºæ•æ„Ÿ/æŠ–åŠ¨** â†’ `yaw_kd += 0.3`
- **è½¬å‘è¿Ÿæ»** â†’ `yaw_kd -= 0.2`

---

### é˜¶æ®µ4ï¼šæ•´ä½“ä¼˜åŒ–

#### æ­¥éª¤4ï¼šé›¶ç‚¹åç½®è°ƒæ•´

å¦‚æœæœºå™¨äººæ€»æ˜¯æœä¸€ä¸ªæ–¹å‘å€¾æ–œï¼š

```cpp
// å‘å‰å€¾æ–œï¼ˆå€’å‘å‰é¢ï¼‰â†’ å‡å° offset
// å‘åå€¾æ–œï¼ˆå€’å‘åé¢ï¼‰â†’ å¢å¤§ offset
pitch_offset = 0.01;  // å•ä½ï¼šå¼§åº¦ï¼Œçº¦ 0.57Â°
```

#### æ­¥éª¤5ï¼šé•¿æœŸç¨³å®šæ€§æµ‹è¯•

æŒç»­è¿è¡Œ 2-3 åˆ†é’Ÿï¼Œè§‚å¯Ÿï¼š
- æŒ¯å¹…æ˜¯å¦ç¨³å®š
- æœ‰æ— ç¼“æ…¢æ¼‚ç§»
- æœ‰æ— å‘¨æœŸæ€§æŒ¯è¡

#### æ­¥éª¤6ï¼šä¿å­˜å‚æ•°

é€šè¿‡ä¸²å£æˆ–Webç•Œé¢ä¿å­˜ï¼š
```
S  (ä¿å­˜åˆ°Flash)
```

---

## é—®é¢˜è¯Šæ–­

### é—®é¢˜1ï¼šæœºå™¨äººä¸åœå‰åæ™ƒåŠ¨

**ç—‡çŠ¶ï¼š**
```
pitch: -0.05 â†’ 0.05 â†’ -0.05 (å‘¨æœŸæ€§ï¼Œçº¦2-5Hz)
```

**å¯èƒ½åŸå› ï¼š**

1. **é˜»å°¼ä¸è¶³**ï¼ˆæœ€å¸¸è§ï¼‰
   - è§£å†³ï¼š`angle_gyro_kd += 0.15`

2. **è§’åº¦å¢ç›Šè¿‡å¤§**
   - è§£å†³ï¼š`angle_kp -= 0.2`

3. **é€Ÿåº¦ç¯å¢ç›Šè¿‡å¤§**
   - è§£å†³ï¼š`velocity_kp -= 0.05`

---

### é—®é¢˜2ï¼šæœºå™¨äººæºœè½¦ï¼ˆä½ç½®æ¼‚ç§»ï¼‰

**ç—‡çŠ¶ï¼š**
- æœºå™¨äººç¼“æ…¢å‘ä¸€ä¸ªæ–¹å‘ç§»åŠ¨
- æ— æ³•ä¿æŒå›ºå®šä½ç½®

**åŸå› ï¼š**
- `velocity_kp` å¤ªå°
- æˆ– `velocity_ki` ä¸è¶³

**è§£å†³ï¼š**
```cpp
velocity_kp = 0.20;   // ä¸è¦ä½äº 0.10
velocity_ki = 0.02;   // æ·»åŠ å°ç§¯åˆ†
```

---

### é—®é¢˜3ï¼šå“åº”è¿Ÿé’

**ç—‡çŠ¶ï¼š**
- æ¨ä¸€ä¸‹ï¼Œå¾ˆä¹…æ‰å›æ­£
- æ„Ÿè§‰"è½¯ç»µç»µ"

**åŸå› ï¼š**
- `angle_gyro_kd` è¿‡å¤§ï¼Œè¿‡åº¦é˜»å°¼
- æˆ– `angle_kp` è¿‡å°

**è§£å†³ï¼š**
```cpp
angle_gyro_kd -= 0.15;
// æˆ–
angle_kp += 0.3;
```

---

### é—®é¢˜4ï¼šæ”¾ä¸œè¥¿åä¸ç¨³å®š

**ç—‡çŠ¶ï¼š**
- ç©ºè½½ç¨³å®š
- åŠ è´Ÿè½½åæŒ¯è¡

**åŸå› ï¼š**
- æƒ¯æ€§å¢å¤§ï¼Œéœ€è¦æ›´å¼ºæ§åˆ¶å¢ç›Š

**è§£å†³ï¼š**
```cpp
angle_kp += 0.4;        // å¢åŠ æ¢å¤åŠ›
angle_gyro_kd += 0.20;  // å¢å¼ºé˜»å°¼
```

---

## å‚æ•°é€ŸæŸ¥è¡¨

### æŒ‰æœºå™¨äººé‡é‡

| é‡é‡ | angle_kp | angle_gyro_kd | velocity_kp | è¯´æ˜ |
|------|---------|---------------|-------------|------|
| 300-500g | 1.5-2.0 | 0.5-0.7 | 0.10-0.15 | è½»é‡çº§ |
| 500-800g | 2.0-2.8 | 0.6-0.9 | 0.15-0.20 | ä¸­é‡çº§ |
| 800-1500g | 2.5-3.5 | 0.8-1.2 | 0.20-0.30 | é‡é‡çº§ |

### æŒ‰è½®èƒç±»å‹

| è½®èƒç±»å‹ | angle_gyro_kd | velocity_kp | è¯´æ˜ |
|---------|---------------|-------------|------|
| è½¯æ©¡èƒ¶ | 0.4-0.6 | 0.10-0.15 | ä½é™æ‘©æ“¦ |
| ç¡¬æ©¡èƒ¶ | 0.6-0.9 | 0.15-0.20 | ä¸­ç­‰ |
| **ç¡¬è´¨è¶Šé‡** | **0.8-1.2** | **0.15-0.25** | éœ€è¦å¼ºé˜»å°¼ |

### æŒ‰é‡å¿ƒé«˜åº¦

| é‡å¿ƒ | angle_kp | angle_gyro_kd | è¯´æ˜ |
|------|---------|---------------|------|
| ä½ï¼ˆåº•ç›˜é«˜åº¦<50%ï¼‰ | 1.5-2.2 | 0.5-0.7 | ç¨³å®š âœ“ |
| ä¸­ï¼ˆ50-70%ï¼‰ | 2.0-3.0 | 0.7-1.0 | ä¸€èˆ¬ |
| **é«˜ï¼ˆ>70%ï¼‰** | **2.5-3.5** | **0.9-1.2** | âš ï¸æ•æ„Ÿ |

### æŒ¯å¹…å¯¹ç…§è¡¨

| æŒ¯å¹… | è¯„ä»· | å»ºè®® |
|------|------|------|
| < 0.01 rad (<0.6Â°) | ä¼˜ç§€ | ç†æƒ³çŠ¶æ€ âœ“ |
| 0.01-0.02 rad (0.6-1.2Â°) | è‰¯å¥½ | æ­£å¸¸æ°´å¹³ |
| 0.02-0.04 rad (1.2-2.3Â°) | å¯æ¥å— | é²æ£’å‚æ•°çš„æ­£å¸¸æ°´å¹³ |
| > 0.04 rad (>2.3Â°) | ä¸ç¨³å®š | éœ€è¦è°ƒæ•´ï¼ |

---

## è°ƒè¯•æŠ€å·§æ€»ç»“

### âœ… æ­£ç¡®åšæ³•

1. **ä¸€æ¬¡åªè°ƒä¸€ä¸ªå‚æ•°**
   - æ”¹äº† `angle_kp` å°±å…ˆæµ‹è¯•ï¼Œå†æ”¹ `angle_gyro_kd`

2. **å°æ­¥è¿­ä»£**
   - æ¯æ¬¡è°ƒæ•´ 0.1-0.3ï¼Œè§‚å¯Ÿæ•ˆæœ

3. **ä»å†…ç¯åˆ°å¤–ç¯**
   - å…ˆè°ƒå¥½è§’åº¦ç¯ï¼Œå†å¯ç”¨é€Ÿåº¦ç¯

4. **è®°å½•æ•°æ®**
   - è®°ä¸‹å‚æ•°å’Œå¯¹åº”çš„æŒ¯å¹…

5. **ä¿å­˜æˆåŠŸé…ç½®**
   - æ‰¾åˆ°å¥½çš„å‚æ•°ç«‹å³ä¿å­˜

### âŒ é”™è¯¯åšæ³•

1. âŒ åŒæ—¶æ”¹å¤šä¸ªå‚æ•°
2. âŒ å¤§å¹…è°ƒæ•´ï¼ˆå¦‚ angle_kp: 1.5 â†’ 4.0ï¼‰
3. âŒ å¤–ç¯å¢ç›Šå¤§äºå†…ç¯ï¼ˆé€Ÿåº¦ç¯å“åº”ä¸åº”å¿«äºè§’åº¦ç¯ï¼‰
4. âŒ å¿½ç•¥ç‰©ç†ç‰¹æ€§ï¼ˆé«˜é‡å¿ƒéœ€è¦é«˜å¢ç›Šï¼‰

---

## é»˜è®¤å‚æ•°å‚è€ƒ

```cpp
// BalanceController::Params é»˜è®¤å€¼
struct Params {
    // Velocity loop (outer) - 50Hz
    float velocity_kp = 0.15f;
    float velocity_ki = 0.02f;
    float velocity_kd = 0.0f;
    float velocity_max_tilt = 0.14f;  // ~8 degrees

    // Angle loop (inner) - 200Hz
    float angle_kp = 1.5f;
    float angle_ki = 0.0f;        // Disabled to prevent drift
    float angle_gyro_kd = 0.6f;   // Manual D term (not SimpleFOC D)
    float angle_d_alpha = 0.7f;   // D-term low-pass filter (0..1, higher=more smoothing)
    float angle_max_out = 6.0f;   // Voltage limit

    // Yaw control
    float yaw_kd = 1.2f;          // Rate damping only

    // Safety
    float max_tilt = 0.6f;        // ~35 degrees
    float ramp_time = 0.5f;       // Soft startup
    float pitch_offset = 0.0f;    // Static trim (rad)
};
```

---

## ç‰ˆæœ¬å†å²

- **v2.0** (2026-02-15): æ›´æ–°ä¸ºçº§è”æ§åˆ¶æ¶æ„å‚æ•°
  - ç§»é™¤æ—§ç‰ˆ LQR å‚æ•°ï¼ˆangle_kp/gyro_kp/distance_kp/lqr_u_ki ç­‰ï¼‰
  - æ–°å¢ velocity_kp/kiã€angle_gyro_kd ç­‰å‚æ•°è¯´æ˜
  - è°ƒæ•´è°ƒè¯•æµç¨‹ä¸ºå†…ç¯â†’å¤–ç¯é¡ºåº

- **v1.0** (2026-02-14): åˆå§‹ç‰ˆæœ¬ï¼ˆåŸºäºæ—§ monolithic æ§åˆ¶å™¨ï¼‰

---

## å‚è€ƒèµ„æ–™

- æ§åˆ¶æ¶æ„ï¼šdocs/decisions/2026-02-12-cascade-control-separation.md
- ä»£ç ï¼šsrc/control/balance_controller.h
- é¡¹ç›®è®°å¿†ï¼šdocs/project_memory.md
